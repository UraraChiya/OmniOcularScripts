<!--Author: UraraChiya-->
<!--Date: 2025/12/24-->
<!--Version: V33a-->
<!--Requie: minecraft.xml-->
<oo>
    <init>
        var LUMENCOLORFORMAT = {
            BLACK: BLACK,
            RED: DRED,
            GREEN: DGREEN,
            BROWN: GOLD,
            BLUE: DBLUE,
            PURPLE: DPURPLE,
            CYAN: DAQUA,
            LIGHTGRAY: GRAY,
            GRAY: DGRAY,
            PINK: LPURPLE,
            LIME: GREEN,
            YELLOW: YELLOW,
            LIGHTBLUE: AQUA,
            MAGENTA: LPURPLE,
            ORANGE: GOLD,
            WHITE: WHITE
        };
        var LUMENIDTOCOLOR = {
            0: 'BLACK',
            1: 'RED',
            2: 'GREEN',
            3: 'BROWN',
            4: 'BLUE',
            5: 'PURPLE',
            6: 'CYAN',
            7: 'LIGHTGRAY',
            8: 'GRAY',
            9: 'PINK',
            10: 'LIME',
            11: 'YELLOW',
            12: 'LIGHTBLUE',
            13: 'MAGENTA',
            14: 'ORANGE',
            15: 'WHITE'
        };
        var LUMENIDTOFORMAT = {
            0: BLACK,
            1: DRED,
            2: DGREEN,
            3: GOLD,
            4: DBLUE,
            5: DPURPLE,
            6: DAQUA,
            7: GRAY,
            8: DGRAY,
            9: LPURPLE,
            10: GREEN,
            11: YELLOW,
            12: AQUA,
            13: LPURPLE,
            14: GOLD,
            15: WHITE
        };
        var LUMENCOLOR = [
            'BLACK',
            'RED',
            'GREEN',
            'BROWN',
            'BLUE',
            'PURPLE',
            'CYAN',
            'LIGHTGRAY',
            'GRAY',
            'PINK',
            'LIME',
            'YELLOW',
            'LIGHTBLUE',
            'MAGENTA',
            'ORANGE',
            'WHITE'
        ];
        var LUMENCOLORTOID = {
            BLACK: 0,
            RED: 1,
            GREEN: 2,
            BROWN: 3,
            BLUE: 4,
            PURPLE: 5,
            CYAN: 6,
            LIGHTGRAY: 7,
            GRAY: 8,
            PINK: 9,
            LIME: 10,
            YELLOW: 11,
            LIGHTBLUE: 12,
            MAGENTA: 13,
            ORANGE: 14,
            WHITE: 15
        };
    </init>
    <init>
        /**
         * 根据目标音高 Key 计算对应的水晶 ID 和和弦 Index
         * ES5 兼容版本
         */
        function solveCrystalMusic(targetKey) {
            /* 基础定义*/
            var C4 = 36;

            /* 音高常量映射 */
            var PITCH = {
                C4: 36,
                D4: 38,
                E4: 40,
                F4: 41,
                G4: 43,
                A4: 45,
                B4: 47,
                C5: 48,
                D5: 50,
                E5: 52,
                F5: 53,
                G5: 55,
                A5: 57,
                C6: 60
            };

            /* 水晶定义 (ID 0-15) */
            var crystals = [
                { id: 0, name: 'Black', base: PITCH.C4, minor: false },
                { id: 1, name: 'Red', base: PITCH.G4, minor: false },
                { id: 2, name: 'Green', base: PITCH.F4, minor: true },
                { id: 3, name: 'Brown', base: PITCH.D4, minor: false },
                { id: 4, name: 'Blue', base: PITCH.E4, minor: false },
                { id: 5, name: 'Purple', base: PITCH.A4, minor: false },
                { id: 6, name: 'Cyan', base: PITCH.A4, minor: true },
                { id: 7, name: 'LightGray', base: PITCH.D5, minor: true },
                { id: 8, name: 'Gray', base: PITCH.C5, minor: true },
                { id: 9, name: 'Pink', base: PITCH.F5, minor: false },
                { id: 10, name: 'Lime', base: PITCH.E5, minor: false },
                { id: 11, name: 'Yellow', base: PITCH.G5, minor: false },
                { id: 12, name: 'LightBlue', base: PITCH.A5, minor: false },
                { id: 13, name: 'Magenta', base: PITCH.B4, minor: false },
                { id: 14, name: 'Orange', base: PITCH.E4, minor: true },
                { id: 15, name: 'White', base: PITCH.C6, minor: false }
            ];

            var results = [];

            /* 使用 forEach (ES5) 和 普通 function */
            crystals.forEach(function (crystal) {
                var notes = [];
                notes[0] = crystal.base;
                notes[1] = crystal.base + (crystal.minor ? 3 : 4);
                notes[2] = crystal.base + 7;
                notes[3] = crystal.base + 12;

                for (var i = 0; i < 4; i++) {
                    if (notes[i] === targetKey) {
                        results.push({
                            crystalId: crystal.id,
                            crystalName: crystal.name,
                            chordIdx: i
                        });
                    }
                }
            });

            return results;
        }
    </init>
    <!-- CC 共有内容 -->
    <tileentity id="CC.*">
        <line displayname="hud.msg.ChromatiCraft.Place">
            var result = '';
            if (nbt.place) {
                result += nbt.place;
            }
            if (nbt.placeUUID && nbt.place != uuid2name(nbt.placeUUID)) {
                result +=
                    ' ' +
                    uuid2name(nbt.placeUUID) +
                    ' ' +
                    translate('hud.msg.ChromatiCraft.Place.NotSamePlayer');
            }
            if (result) return result;
        </line>
        <line displayname="hud.msg.ChromatiCraft.Owner">
            if (nbt.owners[0]) return uuid2name(nbt.owners[0]);
        </line>
        <line displayname="hud.msg.ChromatiCraft.Struct">
            if (nbt.struct == 1) {
                return GREEN + translate('hud.msg.ChromatiCraft.Struct.Formed');
            } else if (nbt.struct == 0) {
                return RED + translate('hud.msg.ChromatiCraft.Struct.Unformed');
            }
        </line>
        <line displayname="hud.msg.ChromatiCraft.Tier">
            return nbt.tier;
        </line>
        <line displayname="hud.msg.ChromatiCraft.CraftRemain">
            if (nbt.craft) {
                return nbt.craft + ' ' + translate('hud.msg.common.Ticks');
            }
        </line>
        <line displayname="hud.msg.ChromatiCraft.Energy">
            if (nbt.energy) {
                switch (typeof nbt.energy) {
                    case 'object':
                        var results = ['\\n'];
                        var lumens = [];
                        for (var i = 0; i < LUMENCOLOR.length; i++) {
                            var color = LUMENCOLOR[i];
                            if (nbt.energy[color]) {
                                lumens.push(
                                    LUMENIDTOFORMAT[i] +
                                        padSpaces(i, 2) +
                                        ': ' +
                                        formatAlignedSI(nbt.energy[color])
                                );
                            }
                        }
                        for (var i = 0; i < lumens.length; i += 2) {
                            if (i + 1 == lumens.length) {
                                results.push(lumens[i]);
                            } else {
                                results.push(lumens[i] + TAB + lumens[i + 1]);
                            }
                        }
                        if (lumens.length > 0) return results.join('\\n  ');
                        break;
                    case 'number':
                        if (nbt.color != undefined) {
                            return LUMENCOLORFORMAT[LUMENCOLOR[nbt.color]] + formatAlignedSI(nbt.energy);
                        }
                        return formatAlignedSI(nbt.energy);
                        break;
                    default:
                        break;
                }
            }
        </line>
    </tileentity>
    <!-- 铸件桌 -->
    <tileentity id="CCchroma.table">
        <line displayname="XP">
            return numberWithCommas(nbt.xp);
        </line>
    </tileentity>
    <!-- 能量塔 -->
    <tileentity id="CCchroma.pylon">
        <line displayname="hud.msg.ChromatiCraft.Struct">
            if (nbt.multi) {
                return GREEN + translate('hud.msg.ChromatiCraft.Struct.Formed');
            } else {
                return RED + translate('hud.msg.ChromatiCraft.Struct.Unformed');
            }
        </line>
    </tileentity>
    <!-- 能量中继器 -->
    <tileentity id="CCchroma.repeater">
        <line displayname="hud.msg.ChromatiCraft.Repeater.Depth">
            return nbt.depth;
        </line>
    </tileentity>
    <!-- 仪式桌 -->
    <tileentity id="CCchroma.ritual">
        <line displayname="hud.msg.ChromatiCraft.Ritual.Ability">
            return nbt.ability;
        </line>
    </tileentity>
    <!-- 嬗变火 -->
    <tileentity id="CCchroma.glowfire">
        <line displayname="hud.msg.ChromatiCraft.Glowfire.Target">
            if (nbt.Items[0]) return name(nbt.Items[0]);
        </line>
    </tileentity>
    <!-- Puzzle -->
    <!-- 水晶音乐存储 -->
    <tileentity id="CCTileMusicMemory">
        <line displayname="hud.msg.ChromatiCraft.Puzzle.Solution">
            if (nbt.keys && nbt.keys.length > 0) {
                var results = ['\\n'];
                /* 对应和弦索引 0, 1, 2, 3 的位置箭头 */
                var arrows = ['↖', '↗', '↘', '↙'];

                for (var i = 0; i < nbt.keys.length; i++) {
                    var key = nbt.keys[i];
                    /* 调用之前定义的解题函数 */
                    var solutions = solveCrystalMusic(key);

                    if (solutions.length > 0) {
                        /* 取第一个可能的解 (通常这就足够了) */
                        var res = solutions[0];

                        /* 获取颜色格式代码 (例如 DRED, DPURPLE 等) */
                        var colorFmt = LUMENIDTOFORMAT[res.crystalId];

                        /* 格式化输出: 颜色代码 + 颜色名 + 方向箭头 */
                        /* 例如: "Purple ↖" (带颜色) */
                        results.push(
                            i +
                                TAB +
                                colorFmt +
                                res.crystalName +
                                ' ' +
                                GRAY +
                                res.crystalId +
                                TAB +
                                colorFmt +
                                arrows[res.chordIdx]
                        );
                    } else {
                        /* 如果找不到对应的解，显示白色未知 */
                        results.push(WHITE + 'Unknown (' + key + ')');
                    }
                }

                /* 在开头加一个换行，确保护符显示在标签下方，并用换行符连接所有步骤 */
                return results.join('\\n  ');
            }
        </line>
    </tileentity>
</oo>