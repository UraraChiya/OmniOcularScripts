<!--Author: UraraChiya-->
<!--Date: 2025/12/22-->
<!--Version: V33a-->
<!--Requie: OmniOcular.xml-->
<oo>
    <init>
        function meetsRequirements(nbt, req) {
            if (req.power && nbt.power < req.power) return false;
            if (req.omega && nbt.omega < req.omega) return false;
            if (req.torque && nbt.torque < req.torque) return false;
            return true;
        }
    </init>
    <init>
        function getRequirementText(nbt, req) {
            var parts = [];
            if (req.power && nbt.power < req.power)
                parts.push(
                    translate('hud.msg.RotaryCraft.Power') + ' ' + numberWithCommas(req.power) + ' W'
                );
            if (req.omega && nbt.omega < req.omega)
                parts.push(
                    translate('hud.msg.RotaryCraft.Omega') + ' ' + numberWithCommas(req.omega) + ' rad/s'
                );
            if (req.torque && nbt.torque < req.torque)
                parts.push(
                    translate('hud.msg.RotaryCraft.Torque') + ' ' + numberWithCommas(req.torque) + ' Nm'
                );
            if (parts.length) return RED + parts.join(', ');
        }
    </init>
    <!--
    GRINDER(MachineRegistry.GRINDER, 			840, 60), //was 900, 60
	BEDROCK(MachineRegistry.BEDROCKBREAKER, 	600, 30),
	BORER(MachineRegistry.BORER, 				720, 40),
	BUCKETFILLER(MachineRegistry.BUCKETFILLER, 	200, 20),
	COMPACTOR(MachineRegistry.COMPACTOR, 		300, 15, 4),
	CRYSTALLIZER(MachineRegistry.CRYSTALLIZER, 	400, 24),
	FERMENTER(MachineRegistry.FERMENTER, 		480, 35),
	EXTRACTOR(MachineRegistry.EXTRACTOR, 		900, 60, 400, 20, 600, 30, 1200, 80),
	FIREWORK(MachineRegistry.FIREWORK, 			300, 16),
	FRACTIONATOR(MachineRegistry.FRACTIONATOR, 	800, 40),
	HEATER(MachineRegistry.HEATER, 				200, 10),
	MAGNETIZER(MachineRegistry.MAGNETIZER, 		400, 20),
	OBSIDIAN(MachineRegistry.OBSIDIAN, 			800, 60),
	PUMP(MachineRegistry.PUMP, 					300, 30),
	PURIFIER(MachineRegistry.PURIFIER, 			800, 40),
	TERRAFORMER(MachineRegistry.TERRAFORMER, 	800, 40),
	WOODCUTTER(MachineRegistry.WOODCUTTER, 		40, 4),
	GRINDSTONE(MachineRegistry.GRINDSTONE,		80, 6),
	REFRIGERATOR(MachineRegistry.REFRIGERATOR,	1000, 80),
	RAM(MachineRegistry.LINEBUILDER,			40, 2),
	CENTRIFUGE(MachineRegistry.CENTRIFUGE,		1200, 60),
	DROPS(MachineRegistry.DROPS,				300, 20),
	SPILLER(MachineRegistry.SPILLER,			22,	2),
	FILLER(MachineRegistry.FILLER,				22,	2);
    -->
    <init>
        function getTotalTime(omega, base, factor) {
            return Math.max(1, Math.ceil(base - factor * log2(omega + 1)));
        }
    </init>
    <init>
        /* 计算最小多少转速可达 1 tick 耗时*/
        function getMinOmegaForOneTick(base, factor) {
            var targetTime = 1;
            var requiredLog = (base - targetTime) / factor;
            var minOmega = Math.pow(2, requiredLog) - 1;
            return Math.ceil(minOmega);
        }
    </init>
    <init>
        function getProcessText(curTime, omega, base, factor) {
            var totalTime = getTotalTime(omega, base, factor);
            var result = curTime + ' / ' + totalTime + ' ' + translate('hud.msg.common.Ticks');
            if (totalTime > 1) {
                var minOmega = getMinOmegaForOneTick(base, factor);
                if (omega < minOmega) {
                    result += ' (' + translate('hud.msg.RotaryCraft.OneTickRequires');
                    result += ' ' + numberWithCommas(minOmega) + ' rad/s' + ')';
                }
            }
            return result;
        }
    </init>
    <init>
        function getLimit(type) {
            switch (type) {
                case 'WOOD':
                    return { omega: 4000, torque: 278 };
                    break;
                case 'STONE':
                    return { omega: 12000, torque: 959 };
                    break;
                case 'STEEL':
                    return { omega: 57000, torque: 7000 };
                    break;
                case 'TUNGSTEN':
                    return { omega: 314000, torque: 10000 };
                    break;
                case 'DIAMOND':
                    return { omega: 4000000, torque: 70000 };
                    break;
                case 'BEDROCK':
                    return { omega: 2147483647, torque: 2147483647 };
                    break;
                default:
                    return { omega: 4000, torque: 278 };
                    break;
            }
        }
    </init>
    <init>
        function getAllTheInfo(param) {
            /* 初始化基础变量，使用 || 确保默认值 */
            var power = param.nbt.power;
            var torque = param.nbt.torque;
            var omega = param.nbt.omega;
            var curTime = param.nbt.CookTime || 0;
            var hasLimit = param.hasLimit || false; /* 是否是象变速箱那样有上限限制*/
            var req = param.req || {}; /* 若有上限限制，则 req 为上限限制，否则为下限限制*/
            var process = param.process || {};

            /* 返回值列表 */
            var results = ['\\n'];

            /* 放置者 */
            if (nbt.place) {
                var tmp = '';
                tmp += nbt.place;
                if (nbt.placeUUID && nbt.place != uuid2name(nbt.placeUUID)) {
                    tmp +=
                        ' UUID: ' +
                        uuid2name(nbt.placeUUID) +
                        ' ' +
                        translate('hud.msg.Reika.Place.NotSamePlayer');
                }
                results.push(customLabelFormat(translate('hud.msg.Reika.Place'), tmp));
            }
            /* 基岩 */
            if (nbt.bedrock) {
                results.push(customLabelFormat(translate('hud.msg.RotaryCraft.Bedrock'), nbt.bedrock));
            }

            var formatInfo = function (val, reqVal, unit, label) {
                var formattedVal = numberWithCommas(val);

                if (reqVal) {
                    /* 判定逻辑说明：
                     * 1. 如果是上限模式 (hasLimit)，绿色条件是 val <= reqVal
                     * 2. 如果是下限模式 (!hasLimit)，绿色条件是 val >= reqVal */
                    var isGreen = hasLimit ? val <= reqVal : val >= reqVal;
                    var color = isGreen ? GREEN : RED;

                    return customLabelFormat(
                        label,
                        color + formattedVal + ' / ' + numberWithCommas(reqVal) + ' ' + unit
                    );
                }

                return customLabelFormat(label, GREEN + formattedVal + ' ' + unit);
            };

            /* 处理三项核心参数 */
            if (power != undefined && torque != undefined && omega != undefined) {
                results.push(formatInfo(power, req.power, 'W', translate('hud.msg.RotaryCraft.Power')));
                results.push(formatInfo(torque, req.torque, 'Nm', translate('hud.msg.RotaryCraft.Torque')));
                results.push(formatInfo(omega, req.omega, 'rad/s', translate('hud.msg.RotaryCraft.Omega')));
            }

            /* 处理进度信息 */
            if (process.base != undefined && process.factor != undefined) {
                results.push(
                    customLabelFormat(
                        translate('hud.msg.common.Process'),
                        getProcessText(curTime, omega, process.base, process.factor)
                    )
                );
            }

            return results.join('\\n  ');
        }
    </init>
    <!--通用信息显示-->
    <tileentity id="RC.*">
        <line displayname='hud.msg.common.Info'>
            if (
                nbt.place == undefined &&
                (nbt.power == undefined || nbt.omega == undefined || nbt.torque == undefined)
            ) {
                return;
            }
            var hasLimit = undefined;
            var req = {};
            var process = {};

            /* 通过特殊 nbt 区分机器 */
            if (nbt.geartype != undefined) {
                /* Gearbox */
                hasLimit = true;
                req = getLimit(nbt.geartype);
            } else if (nbt.shafttype != undefined) {
                /* Shaft */
                hasLimit = true;
                req = getLimit(nbt.shafttype);
            } else if (nbt.grinder != undefined) {
                /* Grinder */
                req = { power: 4096, torque: 128 };
                process = { base: 840, factor: 60 };
            } else if (nbt.fermenter != undefined) {
                /* Fermenter */
                req = { power: 1024, omega: 32 };
                process = { base: 480, factor: 35 };
            } else if (nbt.centrifuge != undefined) {
                /* Centrifuge */
                req = { power: 16384, omega: 4096 };
                process = { base: 1200, factor: 60 };
            } else if (nbt.step != undefined) {
                /* BedrockBreaker */
                req = { power: 4194304, torque: 16384 };
                process = { base: 600, factor: 30 };
            } else if (nbt.furnLoc != undefined) {
                /* Friction */
                req = { power: 8192, torque: 32 };
            } else if (nbt.temperature != undefined) {
                /* Heater */
                req = { power: 8192, torque: 16 };
            } else if (nbt.fractionationunitin != undefined) {
                /* Fractionator */
                req = { power: 65536, omega: 8192 };
                process = { base: 800, factor: 40 };
            } else if (nbt.liquefactionmachine != undefined) {
                /* Wetter */
                req = { power: 4096, omega: 1024 };
            } else if (nbt.accel != undefined && nbt.fuel != undefined) {
                /* Pulsejet */
                req = { omega: 131072 };
            }
            return getAllTheInfo({
                nbt: nbt,
                hasLimit: hasLimit,
                req: req,
                process: process
            });
        </line>
    </tileentity>
    <tileentity id="RCblastfurnace">
        <line displayname='melt'>
            return nbt.melt;
        </line>
    </tileentity>
    <!--
    旋转能源炉将RotaryCraft的轴功率转化为热力膨胀红石通量·由于内部磁场施加的限制，
    它可以在最大1024弧度／秒的情况下承受最大2048Nm的扭矩（如果升级则为8192Nm）。任何多余的能量都会被浪费掉。
    -->
    <tileentity id="RCdynamo">
        <line displayname='hud.msg.RotaryCraft.Dynamo.Generated'>
            var omega = nbt.omega || 0;
            var torque = nbt.torque || 0;
            if (omega > 1024) omega = 1024;
            if (nbt.upgrade) {
                if (torque > 8192) torque = 8192;
            } else {
                if (torque > 2048) torque = 2048;
            }
            return WHITE + (omega * torque) / 512 + ' RF/t';
        </line>
    </tileentity>
    <tileentity id="RCfan">
        <line displayname="hud.msg.RotaryCraft.Fan.Range">
            if (nbt.power) {
                return 8 + (nbt.power - 2048) / 1024 + ' m';
            }
        </line>
        <line displayname="hud.msg.RotaryCraft.Fan.Mode">
            var mode = [];
            if (nbt.omega >= 64) {
                mode.push(translate('hud.msg.RotaryCraft.Fan.FireExtinguish'));
                if (nbt.omega >= 512) {
                    mode.push(translate('hud.msg.RotaryCraft.Fan.Harvesting'));
                }
                return mode.join(', ');
            }
        </line>
    </tileentity>
    <tileentity id="RCextractor">
        <!-- 
            Stage 1 Power: 65536W
            Stage 2 Power: 16384W
            Stage 3 Power: 32768W
            Stage 4 Power: 65536W
            Stage 1 Torque: 512Nm
            Stage 4 Torque: 256Nm
            Stage 2 Omega: 2048rad/s
            Stage 3 Omega: 8192rad/s

            x = Omega
            Stage 1 Time = 900.0-60.0*log_2.0(x+1)
            Stage 2 Time = 400.0-20.0*log_2.0(x+1)
            Stage 3 Time = 600.0-30.0*log_2.0(x+1)
            Stage 4 Time = 1200.0-80.0*log_2.0(x+1)

            {torque:2048,extractor:{FluidName:"water",Amount:16000},emp:0b,no_drops:0b,placeUUID:"34b7ce33-953f-4b7d-871b-6574e8c0c2c0",bedrock:0b,no_mine:0b,pox:0,poz:0,Items:[0:{Slot:2b,id:5861s,Count:16b,Damage:9s},1:{Slot:3b,id:5861s,Count:34b,Damage:17s},2:{Slot:7b,id:5861s,Count:20b,Damage:25s},3:{Slot:8b,id:5861s,Count:1b,Damage:33s}],power:65536L,poy:0,place:"UraraChiya",thisredstone:0b,_:[0:"Class: Reika.RotaryCraft.TileEntities.Processing.TileEntityExtractor",1:"ID: RCextractor",2:"Block: tile..name",3:"Block Class: Reika.RotaryCraft.Blocks.BlockMIMachine",4:"Position: [330, 64, 337]",5:"Mod: RotaryCraft",6:"Ticking: true"],CookTime:[0,0,0,641,],address:"31596210-f7f3-4627-9994-4e7bc2083b2a",io:0,read3:-1,read2:-1,read4:-1,tick:0,omni:0b,drill:4096,lastredstone:0b,omega:32,read1:0,meta:0,write1:-1,age_ticks:25711L,write2:-1}
        -->
        <line displayname="hud.msg.RotaryCraft.Extractor.Stage">
            var stages = [
                {
                    req: { power: 65536, torque: 512 },
                    timefactor: { base: 900, factor: 60 }
                },
                {
                    req: { power: 16384, omega: 2048 },
                    timefactor: { base: 400, factor: 20 }
                },
                {
                    req: { power: 32768, omega: 8192 },
                    timefactor: { base: 600, factor: 30 }
                },
                {
                    req: { power: 65536, torque: 256 },
                    timefactor: { base: 1200, factor: 80 }
                }
            ];

            var result = ['\\n'];

            for (var i = 0; i < stages.length; i++) {
                var stage = stages[i];
                var stageNum = i + 1;
                if (meetsRequirements(nbt, stage.req)) {
                    var processText = getProcessText(
                        nbt.CookTime[i],
                        nbt.omega,
                        stage.timefactor.base,
                        stage.timefactor.factor
                    );
                    var tmp = GREEN + translate('hud.msg.RotaryCraft.Extractor.Stage') + ' ';
                    tmp += stageNum + ': ' + WHITE + ' ' + processText;
                    result.push(tmp);
                } else {
                    var tmp = RED + translate('hud.msg.RotaryCraft.Extractor.Stage') + ' ' + stageNum + ': ';
                    tmp +=
                        translate('hud.msg.RotaryCraft.Requirements') +
                        ': ' +
                        getRequirementText(nbt, stage.req);
                    result.push(tmp);
                }
            }

            if (result.length > 1) return result.join('\\n  ');
        </line>
    </tileentity>
    <tileentity id="RCfriction">
        <line displayname='hud.msg.RotaryCraft.Friction.MaxTemperature'>
            /* 温度公式为 ：T=12*log2(omega 速度)*log2(torque 扭矩) + 30 (在满足机器最低运行要求的情况下) */
            var omega = nbt.omega || 0;
            var torque = nbt.torque || 0;
            if (meetsRequirements(nbt, { power: 8192, torque: 32 })) {
                var temp = 12 * log2(omega) * log2(torque) + 30;
                var avg = Math.sqrt(omega * torque);
                var maxTemp = 12 * log2(avg) * log2(avg) + 30;
                return Math.floor(temp) + ' / ' + Math.floor(maxTemp) + ' °C';
            }
        </line>
    </tileentity>
    <tileentity id="RCac">
        <line displayname='hud.msg.RotaryCraft.Magnet'>
            return nbt.Items[0].tag.magnet + ' ' + translate('hud.msg.RotaryCraft.MicroTesla');
        </line>
    </tileentity>
    <tileentity id="RCmagnetizer">
        <line displayname='hud.msg.RotaryCraft.Requirements'>
            return getRequirementText(nbt, { power: 16384, omega: 2048 });
        </line>
        <line displayname='hud.msg.RotaryCraft.Magnet'>
            return nbt.Items[0].tag.magnet + ' ' + translate('hud.msg.RotaryCraft.MicroTesla');
        </line>
    </tileentity>
</oo>
