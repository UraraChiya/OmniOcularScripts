<!--Author: UraraChiya-->
<!--Date: 2025/12/22-->
<!--Version: V33a-->
<!--Requie: OmniOcular.xml-->
<oo>
    <init>
        /* 直接从 Java 类中获取静态常量和方法 */
        var ReikaRFHelper = Packages.Reika.DragonAPI.ModInteract.Power.ReikaRFHelper;
        var ReikaEUHelper = Packages.Reika.DragonAPI.ModInteract.Power.ReikaEUHelper;
        var ConfigRegistry = Packages.Reika.RotaryCraft.Registry.ConfigRegistry;
        var RotaryCraftConfigRegistry = Packages.Reika.RotaryCraft.Registry.ConfigRegistry;
        var Dynamo = Packages.Reika.RotaryCraft.ModInterface.Conversion.TileEntityDynamo;
        var PowerReceivers = Packages.Reika.RotaryCraft.Registry.PowerReceivers;

        /**
         * 获取机器特定阶段的动力需求
         * @param {string} machineName - 机器枚举名 (如 "EXTRACTOR")
         * @param {number} stage       - 阶段索引 (0, 1, 2, 3...)
         */
        function getMachinePowerRequirements(machineName, stage) {
            stage = stage || 0;
            try {
                var entry = PowerReceivers.valueOf(machineName);

                /* 检查该机器是否拥有多个阶段的动力数值 */
                if (entry.hasMultiValuedPower()) {
                    /* 获取该机器支持的最大阶段数，防止传入越界的 stage */
                    var maxStages = entry.getMultiValuedPowerTypes();
                    var s = Math.min(stage, maxStages - 1);

                    return {
                        torque: entry.getMinTorque(s),
                        omega: entry.getMinSpeed(s),
                        power: entry.getMinPower(s),
                        isMultiStage: true
                    };
                } else {
                    /* 普通单阶段机器 */
                    return {
                        torque: entry.getMinTorque(),
                        omega: entry.getMinSpeed(),
                        power: entry.getMinPower(),
                        isMultiStage: false
                    };
                }
            } catch (e) {
                /* 如果发生异常，返回默认最低动力需求 */
                return { torque: 1, omega: 1, power: 1, isMultiStage: false };
            }
        }
    </init>
    <init>
        function meetsRequirements(nbt, req) {
            if (req.power && nbt.power < req.power) return false;
            if (req.omega && nbt.omega < req.omega) return false;
            if (req.torque && nbt.torque < req.torque) return false;
            return true;
        }
    </init>
    <init>
        function getRequirementText(nbt, req) {
            var parts = [];
            /* 检查并列出所有未达标的项 */
            if (nbt.power < req.power) parts.push(numberWithCommas(req.power) + ' W');
            if (nbt.torque < req.torque) parts.push(numberWithCommas(req.torque) + ' Nm');
            if (nbt.omega < req.omega) parts.push(numberWithCommas(req.omega) + ' rad/s');

            return RED + translate('hud.msg.RotaryCraft.Requirements') + ': ' + parts.join(', ');
        }
    </init>
    <init>
        /* 计算最小多少转速可达 1 tick 耗时*/
        function getMinOmegaForOneTick(base, factor) {
            var targetTime = 1;
            var requiredLog = (base - targetTime) / factor;
            var minOmega = Math.pow(2, requiredLog) - 1;
            return Math.ceil(minOmega);
        }
        var DurationRegistry = Packages.Reika.RotaryCraft.Registry.DurationRegistry;
        /* 自动推导机器的 base 和 factor */
        function getMachineConstants(machineName, stage) {
            var machine = DurationRegistry.valueOf(machineName);

            /* 利用转速 0 (log2(1)=0) 和转速 1 (log2(2)=1) 获取两个时间点 */
            /* t = base - factor * log2(omega + 1) */
            var t0 = machine.getOperationTime(0, stage); /* 此时 t0 = base */
            var t1 = machine.getOperationTime(1, stage); /* 此时 t1 = base - factor */

            var base = t0;
            var factor = t0 - t1;

            return { base: base, factor: factor };
        }
        function getProcessText(curTime, omega, machineName, stage) {
            stage = stage || 0;

            var machine = DurationRegistry.valueOf(machineName);

            /* 直接调用 Java 获取当前真实值 */
            var operationTime = machine.getOperationTime(omega, stage);
            var numOps = machine.getNumberOperations(omega, stage);
            var result = curTime + ' / ' + operationTime + ' ' + translate('hud.msg.common.Ticks');

            if (numOps > 1) {
                result += ' (' + numOps + 'x ' + translate('hud.msg.RotaryCraft.OperationsPerTick') + ')';
            } else if (operationTime > 1) {
                /* 自动获取该机器该阶段的系数 */
                var constants = getMachineConstants(machineName, stage);
                var minOmega = getMinOmegaForOneTick(constants.base, constants.factor);

                if (omega < minOmega) {
                    result += ' (' + translate('hud.msg.RotaryCraft.OneTickRequires');
                    result += ' ' + numberWithCommas(minOmega) + ' rad/s' + ')';
                }
            }
            return result;
        }
    </init>
    <init>
        function getLimit(type) {
            switch (type) {
                case 'WOOD':
                    return { omega: 4000, torque: 278 };
                    break;
                case 'STONE':
                    return { omega: 12000, torque: 959 };
                    break;
                case 'STEEL':
                    return { omega: 57000, torque: 7000 };
                    break;
                case 'TUNGSTEN':
                    return { omega: 314000, torque: 10000 };
                    break;
                case 'DIAMOND':
                    return { omega: 4000000, torque: 70000 };
                    break;
                case 'BEDROCK':
                    return { omega: 2147483647, torque: 2147483647 };
                    break;
                default:
                    return { omega: 4000, torque: 278 };
                    break;
            }
        }
    </init>
    <init>
        function getAllTheInfo(param) {
            /* 初始化基础变量，使用 || 确保默认值 */
            var power = param.nbt.power;
            var torque = param.nbt.torque;
            var omega = param.nbt.omega;
            var curTime = param.nbt.CookTime || 0;
            var hasLimit = param.hasLimit || false; /* 是否是象变速箱那样有上限限制*/
            var machineName = param.machineName;
            var bedrock = param.nbt.bedrock;

            /* 返回值列表 */
            var results = ['\\n'];

            /* 基岩 */
            if (bedrock) {
                results.push(customLabelFormat(translate('hud.msg.RotaryCraft.Bedrock'), nbt.bedrock));
            }

            var formatInfo = function (val, reqVal, unit, label) {
                var formattedVal = numberWithCommas(val);

                if (reqVal) {
                    /* 判定逻辑说明：
                     * 1. 如果是上限模式 (hasLimit)，绿色条件是 val <= reqVal
                     * 2. 如果是下限模式 (!hasLimit)，绿色条件是 val >= reqVal*/
                    var isGreen = hasLimit ? val <= reqVal : val >= reqVal;
                    var color = isGreen ? GREEN : RED;

                    return customLabelFormat(
                        label,
                        color + formattedVal + ' / ' + numberWithCommas(reqVal) + ' ' + unit
                    );
                }

                return customLabelFormat(label, GREEN + formattedVal + ' ' + unit);
            };

            /* 处理三项核心参数 */
            var req = getMachinePowerRequirements(machineName, 0);
            if (req.isMultiStage) {
                req.torque = 1;
                req.omega = 1;
                req.power = 1;
            }
            if (power != undefined && torque != undefined && omega != undefined) {
                results.push(formatInfo(power, req.power, 'W', translate('hud.msg.RotaryCraft.Power')));
                results.push(formatInfo(torque, req.torque, 'Nm', translate('hud.msg.RotaryCraft.Torque')));
                results.push(formatInfo(omega, req.omega, 'rad/s', translate('hud.msg.RotaryCraft.Omega')));
            }

            /* 处理进度信息 */
            if (machineName != undefined) {
                try {
                    var machine = DurationRegistry.valueOf(machineName);
                    var stages = machine.getNumberStages();
                    if (stages == 1) {
                        if (meetsRequirements(nbt, req)) {
                            results.push(
                                customLabelFormat(
                                    translate('hud.msg.common.Process'),
                                    getProcessText(curTime, omega, machineName, 0)
                                )
                            );
                        }
                    } else {
                        var processResults = ['\\n'];
                        for (var stage = 0; stage < stages; stage++) {
                            var req = getMachinePowerRequirements(machineName, stage);
                            var stageNum = stage + 1;
                            if (meetsRequirements(nbt, req)) {
                                var processText = getProcessText(
                                    nbt.CookTime[stage],
                                    nbt.omega,
                                    machineName,
                                    stage
                                );
                                var tmp = GREEN + translate('hud.msg.RotaryCraft.Stage') + ' ';
                                tmp += stageNum + ': ' + WHITE + ' ' + processText;
                                processResults.push(tmp);
                            } else {
                                var tmp =
                                    RED + translate('hud.msg.RotaryCraft.Stage') + ' ' + stageNum + ': ';
                                tmp +=
                                    translate('hud.msg.RotaryCraft.Requirements') +
                                    ': ' +
                                    getRequirementText(nbt, req);
                                processResults.push(tmp);
                            }
                        }
                        results.push(
                            customLabelFormat(
                                translate('hud.msg.common.Process'),
                                processResults.join('\\n    ')
                            )
                        );
                    }
                } catch (error) {}
            }

            return results.join('\\n  ');
        }
    </init>
    <tileentity id="RC.*">
        <line displayname="hud.msg.Reika.Place">
            var result = '';
            if (nbt.place) {
                result += nbt.place;
            }
            if (nbt.placeUUID && nbt.place != uuid2name(nbt.placeUUID)) {
                result +=
                    ' UUID: ' + uuid2name(nbt.placeUUID) + ' ' + translate('hud.msg.Reika.Place.NotSamePlayer');
            }
            if (result) return result;
        </line>
    </tileentity>
    <tileentity id="RCsplitter">
        <line displayname='hud.msg.common.Info'>
            return getAllTheInfo({ nbt: nbt });
        </line>
    </tileentity>
    <tileentity id="RC.*gears">
        <line displayname='hud.msg.common.Info'>
            return getAllTheInfo({ nbt: nbt });
        </line>
    </tileentity>
    <tileentity id="RCscalechest">
        <line displayname='hud.msg.common.Info'>
            return getAllTheInfo({ nbt: nbt, machineName: 'SCALECHEST' });
        </line>
        <line displayname='hud.msg.RotaryCraft.ScaleChest.Slots'>
            var ScaleChest = Packages.Reika.RotaryCraft.TileEntities.Storage.TileEntityScaleableChest;
            /* 动态获取 Java 类中定义的常量 */
            var FALLOFF = ScaleChest.FALLOFF;
            var MAXSIZE = ScaleChest.MAXSIZE;
            var MAXROWS = ScaleChest.MAXROWS;

            /* 获取动力需求门槛 */
            var req = getMachinePowerRequirements('SCALECHEST', 0);
            var MINPOWER = req.power;

            var power = nbt.power;
            var currentSlots = 0;

            /* 完美模拟 Java 层的 getNumberSlots() 逻辑 */
            if (power < MINPOWER) {
                currentSlots = 9;
            } else {
                /* Java 源码: size = 9 + (int)(power - MINPOWER) / FALLOFF; */
                currentSlots = 9 + Math.floor((power - MINPOWER) / FALLOFF);
            }
            /* 确保不超过最大值 */
            currentSlots = Math.min(MAXSIZE, currentSlots);

            return currentSlots.toFixed(0);
        </line>
    </tileentity>
    <tileentity id="RCpulsejet">
        <line displayname='hud.msg.common.Info'>
            return getAllTheInfo({ nbt: nbt, machineName: 'PULSEJET' });
        </line>
    </tileentity>
    <tileentity id="RCwetter">
        <line displayname='hud.msg.common.Info'>
            return getAllTheInfo({ nbt: nbt, machineName: 'WETTER' });
        </line>
    </tileentity>
    <tileentity id="RCfractionator">
        <line displayname='hud.msg.common.Info'>
            return getAllTheInfo({ nbt: nbt, machineName: 'FRACTIONATOR' });
        </line>
    </tileentity>
    <tileentity id="RCheater">
        <line displayname='hud.msg.common.Info'>
            return getAllTheInfo({ nbt: nbt, machineName: 'HEATER' });
        </line>
    </tileentity>
    <tileentity id="RCshaft">
        <line displayname='hud.msg.common.Info'>
            return getAllTheInfo({
                nbt: nbt,
                hasLimit: true,
                req: getLimit(nbt.shafttype)
            });
        </line>
    </tileentity>
    <tileentity id="RCgearbox">
        <line displayname='hud.msg.common.Info'>
            return getAllTheInfo({
                nbt: nbt,
                hasLimit: true,
                req: getLimit(nbt.geartype)
            });
        </line>
    </tileentity>
    <tileentity id="RCbedrockbreaker">
        <line displayname='hud.msg.common.Info'>
            return getAllTheInfo({ nbt: nbt, machineName: 'BEDROCKBREAKER' });
        </line>
    </tileentity>
    <tileentity id="RCfermenter">
        <line displayname='hud.msg.common.Info'>
            return getAllTheInfo({ nbt: nbt, machineName: 'FERMENTER' });
        </line>
    </tileentity>
    <tileentity id="RCcentrifuge">
        <line displayname='hud.msg.common.Info'>
            return getAllTheInfo({ nbt: nbt, machineName: 'CENTRIFUGE' });
        </line>
    </tileentity>
    <tileentity id="RCgrinder">
        <line displayname='hud.msg.common.Info'>
            return getAllTheInfo({ nbt: nbt, machineName: 'GRINDER' });
        </line>
    </tileentity>
    <tileentity id="RCcompactor">
        <line displayname='hud.msg.common.Info'>
            return getAllTheInfo({ nbt: nbt, machineName: 'COMPACTOR' });
        </line>
    </tileentity>
    <tileentity id="RCblastfurnace">
        <line displayname='melt'>
            return nbt.melt;
        </line>
    </tileentity>
    <tileentity id="RCdynamo">
        <line displayname='hud.msg.common.Info'>
            return getAllTheInfo({ nbt: nbt, machineName: 'DYNAMO' });
        </line>
        <line displayname='hud.msg.RotaryCraft.Generated'>
            /* 1. 从 Java 类中获取硬编码的上限 */
            var maxTq = nbt.upgrade ? Dynamo.MAXTORQUE_UPGRADE : Dynamo.MAXTORQUE;
            var maxOm = Dynamo.MAXOMEGA;

            /* 2. 模拟 getGenRF 内部的 Math.min 逻辑 */
            var tq = Math.min(nbt.torque, maxTq);
            var om = Math.min(nbt.omega, maxOm);

            /* 3. 获取动态的物理转换常数 (关键点) */
            /* 无论玩家怎么改配置，这个调用拿到的永远是游戏当前运行的值 */
            var wattsPerRF = ReikaRFHelper.getWattsPerRF();
            var efficiency = ConfigRegistry.getConverterEfficiency();

            /* 4. 计算功率并转换 */
            var pwr = tq * om;
            var rt = {
                /* 模拟 Java 的 (int) 强制转换 */
                rf: Math.floor((pwr / wattsPerRF) * efficiency),
                tq: tq,
                om: om
            };

            return rt.rf + ' RF/t @ ' + rt.om + ' rad/s ' + rt.tq + ' Nm';
        </line>
    </tileentity>
    <tileentity id='RCgenerator'>
        <line displayname='hud.msg.common.Info'>
            return getAllTheInfo({ nbt: nbt, machineName: 'GENERATOR' });
        </line>
        <line displayname='hud.msg.RotaryCraft.Generated'>
            /* 1. 动态读取配置和转换常量 (保持原样) */
            var hardModeEU = RotaryCraftConfigRegistry.HARDEU.getState();
            var efficiency = RotaryCraftConfigRegistry.getConverterEfficiency();
            var wattsPerEU = ReikaEUHelper.getWattsPerEU();

            var power = nbt.power;
            var torque = nbt.torque;
            var upgraded = nbt.upgrade;

            /* 2. 计算功率损耗阈值 */
            var t_loss_threshold = upgraded ? 512 : 128;
            var powerLoss = 0;
            if (torque > t_loss_threshold) {
                var diff = torque - t_loss_threshold;
                var multiplier = upgraded ? 0.0625 : 0.125;
                powerLoss = Math.floor(Math.pow(diff, 2) * multiplier);
            }

            /* 3. 计算实际 EU 产出 */
            var netPower = Math.max(0, power - powerLoss);
            var offeredEU = Math.floor((netPower / wattsPerEU) * efficiency);

            /* 4. 爆炸风险计算 */
            var dangerLimit = upgraded ? 4096 : 1024;
            var explosionChance = 0;
            var isOverLimit = hardModeEU && torque > dangerLimit;
            if (isOverLimit) {
                explosionChance = Math.floor(((torque - dangerLimit) / 20000) * 100);
            }

            var results = ['\\n'];

            /* A. 显示 EU 产出 */
            results.push(
                customLabelFormat(
                    translate('hud.msg.RotaryCraft.Generator.Output'),
                    GREEN + numberWithCommas(offeredEU.toFixed(0)) + ' EU/t'
                )
            );

            /* B. 产生损耗时的逻辑：显示损失并提醒优化 */
            if (powerLoss > 0) {
                /* 显示损失了多少 W */
                results.push(
                    customLabelFormat(
                        translate('hud.msg.RotaryCraft.Generator.PowerLoss'),
                        RED + '-' + numberWithCommas(powerLoss.toFixed(0)) + ' W'
                    )
                );
                /* 增加优化提醒 (本地化词条: hud.msg.RotaryCraft.OptimizeSuggestion) */
                /* 建议翻译: "请降低扭矩至 %d Nm 以下以消除损耗" */
                results.push(
                    ITALIC +
                        GOLD +
                        '  -> ' +
                        translate('hud.msg.RotaryCraft.Generator.OptimizeSuggestion') +
                        ': ' +
                        t_loss_threshold
                );
            }

            /* C. 困难模式显示 */
            if (hardModeEU) {
                if (isOverLimit) {
                    var chanceStr = Math.min(100, explosionChance).toFixed(0);
                    results.push(
                        RED +
                            '⚠ ' +
                            translate('hud.msg.RotaryCraft.Generator.ExplosionRisk') +
                            ' (' +
                            numberWithCommas(dangerLimit) +
                            'Nm+): ' +
                            chanceStr +
                            '% ⚠'
                    );
                }

                /* 冷却液检查 */
                if (!nbt.tank || nbt.tank.Amount <= 0) {
                    results.push(RED + '⚠ ' + translate('hud.msg.RotaryCraft.Generator.NoCoolant') + ' ⚠');
                }
            }

            /* D. 升级状态 */
            if (upgraded) {
                results.push(AQUA + '[' + translate('upgrade.flux') + ']');
            }

            return results.join('\\n  ');
        </line>
    </tileentity>
    <tileentity id="RCfan">
        <line displayname='hud.msg.common.Info'>
            return getAllTheInfo({ nbt: nbt, machineName: 'FAN' });
        </line>
        <line displayname="hud.msg.RotaryCraft.Fan.Range">
            if (nbt.power) {
                return 8 + (nbt.power - 2048) / 1024 + ' m';
            }
        </line>
        <line displayname="hud.msg.RotaryCraft.Fan.Mode">
            var mode = [];
            if (nbt.omega >= 64) {
                mode.push(translate('hud.msg.RotaryCraft.Fan.FireExtinguish'));
                if (nbt.omega >= 512) {
                    mode.push(translate('hud.msg.RotaryCraft.Fan.Harvesting'));
                }
                return mode.join(', ');
            }
        </line>
    </tileentity>
    <tileentity id="RCextractor">
        <line displayname='hud.msg.common.Info'>
            return getAllTheInfo({ nbt: nbt, machineName: 'EXTRACTOR' });
        </line>
    </tileentity>
    <tileentity id="RCfriction">
        <line displayname='hud.msg.common.Info'>
            return getAllTheInfo({ nbt: nbt, machineName: 'FRICTION' });
        </line>
        <line displayname='hud.msg.RotaryCraft.Friction.MaxTemperature'>
            /* 温度公式为 ：T=12*log2(omega 速度)*log2(torque 扭矩) + 30 (在满足机器最低运行要求的情况下) */
            var omega = nbt.omega || 0;
            var torque = nbt.torque || 0;
            if (meetsRequirements(nbt, { power: 8192, torque: 32 })) {
                var temp = 12 * log2(omega) * log2(torque) + 30;
                var avg = Math.sqrt(omega * torque);
                var maxTemp = 12 * log2(avg) * log2(avg) + 30;
                return Math.floor(temp) + ' / ' + Math.floor(maxTemp) + ' °C';
            }
        </line>
    </tileentity>
    <tileentity id="RCac">
        <line displayname='hud.msg.RotaryCraft.Magnet'>
            return nbt.Items[0].tag.magnet + ' ' + translate('hud.msg.RotaryCraft.MicroTesla');
        </line>
    </tileentity>
    <tileentity id="RCmagnetizer">
        <line displayname='hud.msg.RotaryCraft.Requirements'>
            return getAllTheInfo({ nbt: nbt, machineName: 'MAGNETIZER' });
        </line>
        <line displayname='hud.msg.RotaryCraft.Magnet'>
            return nbt.Items[0].tag.magnet + ' ' + translate('hud.msg.RotaryCraft.MicroTesla');
        </line>
    </tileentity>
</oo>
