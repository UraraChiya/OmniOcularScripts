<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¼‚å½¢æ•°ç‹¬ç¼–è¾‘å™¨ - ç¾åŒ–ä¿®å¤ç‰ˆ</title>
    <style>
        :root { 
            --cell-size: 45px; 
            --label-size: 30px; 
            --bg-primary: #2a2a2a;
            --bg-secondary: #333;
            --border-color: #444;
            --highlight-color: #f1c40f;
        }
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: #1a1a1a; color: #eee; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        
        /* --- é¡¶éƒ¨å›ºå®šå·¥å…·æ  --- */
        .fixed-toolbar { 
            background: var(--bg-primary); padding: 20px; border-radius: 12px; 
            display: flex; flex-wrap: wrap; gap: 25px; margin-bottom: 25px; 
            border: 1px solid var(--border-color); box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            align-items: stretch;
        }

        .tool-group { display: flex; flex-direction: column; gap: 10px; }
        .tool-label { font-size: 12px; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .divider { width: 1px; background: var(--border-color); margin: 5px 0; }

        .brush-container { display: flex; gap: 20px; align-items: flex-start; }
        .special-mode-container {
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            padding-right: 20px; border-right: 1px solid var(--border-color);
        }
        .mode-row { display: flex; gap: 8px; }
        .mode-label { font-size: 10px; color: #888; }
        .palette { display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px; }

        .color-swatch { 
            width: 30px; height: 30px; border: 2px solid #555; cursor: pointer; border-radius: 6px; 
            display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; 
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); 
            position: relative;
        }
        .color-swatch:hover { transform: translateY(-2px); border-color: #777; }
        .color-swatch.active { 
            border-color: #fff; box-shadow: 0 4px 12px rgba(255,255,255,0.3); 
            transform: translateY(-2px) scale(1.05); z-index: 2; 
        }
        
        .btn-mode { background: var(--bg-secondary); font-size: 18px; }
        .btn-mode.active { border-color: #fff; box-shadow: 0 4px 12px rgba(255,255,255,0.2); }
        .btn-no-brush { color: #ff6b81; }
        .btn-x-brush { color: #f1c40f; }

        .control-row { display: flex; gap: 12px; }
        .size-control { 
            display: flex; align-items: center; gap: 2px; background: var(--bg-secondary); 
            padding: 4px; border-radius: 6px; border: 1px solid var(--border-color); 
        }
        .size-label-span { font-size: 11px; color: #aaa; padding: 0 6px; }
        .size-input { 
            width: 36px; background: transparent; border: none; color: var(--highlight-color); 
            text-align: center; font-size: 15px; font-weight: bold; outline: none; 
            font-family: monospace;
        }
        .btn-mini { width: 26px; height: 26px; border-radius: 4px; border: none; background: #444; color: white; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }

        .btn-action { padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; color: white; transition: all 0.2s; }
        .btn-reset-num { background: #e67e22; }
        .btn-reset-reg { background: #c0392b; }

        /* --- æ¸¸æˆåŒºåŸŸ --- */
        .game-viewport { 
            background: var(--bg-primary); padding: 30px; border-radius: 16px; 
            display: inline-block; box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        .game-layout { display: grid; grid-template-columns: var(--label-size) auto; grid-template-rows: var(--label-size) auto; align-items: center; }
        .coord-container { display: flex; }
        .coord-container.cols { grid-column: 2; flex-direction: row; }
        .coord-container.rows { grid-row: 2; flex-direction: column; }
        .label { display: flex; align-items: center; justify-content: center; font-size: 12px; color: #777; font-weight: 600; font-family: monospace; }
        .label.col { width: var(--cell-size); }
        .label.row { height: var(--cell-size); width: var(--label-size); }

        #boardContainer { grid-column: 2; grid-row: 2; background: #ccc; border: 3px solid var(--bg-primary); overflow: hidden; }
        table { border-collapse: collapse; table-layout: fixed; }
        td { width: var(--cell-size); height: var(--cell-size); padding: 0; border: 1px solid #bbb; background: #eee; box-sizing: border-box; position: relative; }
        
        .rid-badge { position: absolute; top: 2px; right: 3px; font-size: 9px; color: rgba(0,0,0,0.35); z-index: 10; pointer-events: none; font-weight: 600; }
        .active-brush-highlight { background-color: #fff !important; }

        .b-t { border-top: 3px solid #111 !important; } .b-b { border-bottom: 3px solid #111 !important; }
        .b-l { border-left: 3px solid #111 !important; } .b-r { border-right: 3px solid #111 !important; }

        input.cell-input { width: 100%; height: 100%; border: none; background: transparent; text-align: center; font-size: 20px; font-weight: bold; outline: none; display: block; position: relative; z-index: 5; }
        
        /* --- ä¿®å¤ï¼šè°ƒæ•´ X çš„æ ·å¼ï¼Œä½¿å…¶æ›´å°ä¸”ä¸åŠ ç²— --- */
        input.cell-input.is-x { 
            background: #888; 
            color: #000 !important; 
            cursor: not-allowed;
            font-size: 16px;   /* å‡å°å­—å· */
            font-weight: normal; /* å–æ¶ˆåŠ ç²— */
        }

        /* --- åº•éƒ¨æ§åˆ¶ --- */
        .solve-section { margin-top: 30px; text-align: center; }
        .btn-solve { background: #27ae60; color: white; padding: 14px 40px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4); }
        #status { color: var(--highlight-color); margin-top: 15px; font-weight: bold; font-size: 18px; }

        #statsTableContainer { margin-top: 25px; display: none; background: var(--bg-primary); padding: 15px 20px; border-radius: 12px; border: 1px solid var(--border-color); width: 100%; max-width: 550px; }
        .stats-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; text-align: center; }
        .stat-item { padding: 6px; border-radius: 6px; background: var(--bg-secondary); border: 1px solid var(--border-color); }
        .stat-num { font-weight: bold; font-size: 15px; }
        .stat-count { font-size: 11px; color: #aaa; margin-top: 2px; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="fixed-toolbar">
    <div class="tool-group">
        <span class="tool-label">1. é€‰åŒºç¬”åˆ· (å³é”®å¸å–)</span>
        <div class="brush-container">
            <div class="special-mode-container">
                <div class="mode-row">
                    <div id="btn-none" class="color-swatch btn-mode btn-no-brush" onclick="selectBrush(-1)" title="ç¦ç”¨åˆ·å­ï¼šä»…ä¿®æ”¹æ•°å­—">ğŸš«</div>
                    <div id="btn-x" class="color-swatch btn-mode btn-x-brush" onclick="selectBrush(-2)" title="ç¦æ­¢ä½ï¼šæ ‡è®°æ ¼å­ä¸ºX">X</div>
                </div>
                <span class="mode-label">ç‰¹æ®Šæ¨¡å¼</span>
            </div>
            <div class="palette" id="palette"></div>
        </div>
    </div>
    <div class="divider"></div>
    <div class="tool-group">
        <span class="tool-label">2. æ£‹ç›˜å°ºå¯¸</span>
        <div class="control-row">
            <div class="size-control">
                <span class="size-label-span">è¡Œ</span>
                <button class="btn-mini" onclick="resize(-1, 0)">-</button>
                <input type="text" class="size-input" id="rowInput" value="6" onchange="manualResize()">
                <button class="btn-mini" onclick="resize(1, 0)">+</button>
            </div>
            <div class="size-control">
                <span class="size-label-span">åˆ—</span>
                <button class="btn-mini" onclick="resize(0, -1)">-</button>
                <input type="text" class="size-input" id="colInput" value="6" onchange="manualResize()">
                <button class="btn-mini" onclick="resize(0, 1)">+</button>
            </div>
        </div>
    </div>
    <div class="divider"></div>
    <div class="tool-group">
        <span class="tool-label">3. å¿«é€Ÿæ¸…é™¤</span>
        <div class="control-row">
            <button class="btn-action btn-reset-num" onclick="clearNumbers()">ä»…æ¸…é™¤æ•°å­—</button>
            <button class="btn-action btn-reset-reg" onclick="clearRegions()">é‡ç½®æ‰€æœ‰åŒºåŸŸ</button>
        </div>
    </div>
</div>

<div class="game-viewport">
    <div class="game-layout">
        <div class="coord-container cols" id="colHeader"></div>
        <div class="coord-container rows" id="rowHeader"></div>
        <div id="boardContainer"></div>
    </div>
</div>

<div id="statsTableContainer">
    <div class="tool-label" style="margin-bottom: 12px; text-align: center;">æ•°å­—å‡ºç°é¢‘ç‡ç»Ÿè®¡</div>
    <div id="statsGrid" class="stats-grid"></div>
</div>

<div class="solve-section">
    <div id="status">å‡†å¤‡å°±ç»ª (èŒƒå›´ 0-15)</div>
    <div id="counter" style="font-size: 12px; color: #777; font-family: monospace; height: 20px; margin-top: 5px;"></div>
    <div style="margin-top: 15px;">
        <button id="solveBtn" class="btn-solve" onclick="startSolving()">å¼€å§‹æ±‚è§£ (Solve)</button>
        <button id="stopBtn" class="btn-solve" style="background:#c0392b; display:none;" onclick="stopSolving()">å¼ºåˆ¶åœæ­¢</button>
    </div>
</div>

<script>
const COLOR_MAP = {
    0: 'BLACK', 1: 'RED', 2: 'GREEN', 3: 'BROWN', 4: 'BLUE', 5: 'PURPLE', 6: 'CYAN', 7: 'LIGHTGRAY',
    8: 'GRAY', 9: 'PINK', 10: 'LIME', 11: 'YELLOW', 12: 'LIGHTBLUE', 13: 'MAGENTA', 14: 'ORANGE', 15: 'WHITE'
};

let rows = 6, cols = 6;
// grid å€¼: -1 ä¸ºç©º, -2 ä¸º X, 0-15 ä¸ºé¢„è®¾æ•°å­—
let grid = Array(rows).fill().map(() => Array(cols).fill(-1));
let regions = Array(rows).fill().map(() => Array(cols).fill(0));
let activeRegion = 0, isMouseDown = false, stopFlag = false, iterations = 0;

function initPalette() {
    const p = document.getElementById('palette');
    p.innerHTML = '';
    for (let i = 0; i < 16; i++) {
        const div = document.createElement('div');
        div.className = `color-swatch ${i===activeRegion?'active':''}`;
        div.id = `swatch-${i}`;
        div.style.backgroundColor = COLOR_MAP[i];
        div.innerText = i;
        const darkTextIndices = [6, 7, 9, 10, 11, 12, 14, 15]; 
        div.style.color = darkTextIndices.includes(i) ? '#000' : '#fff';
        div.onclick = () => selectBrush(i);
        p.appendChild(div);
    }
    updateModeButtons();
}

function updateModeButtons() {
    document.getElementById('btn-none').classList.toggle('active', activeRegion === -1);
    document.getElementById('btn-x').classList.toggle('active', activeRegion === -2);
}

function selectBrush(id) {
    activeRegion = id;
    document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
    if(id >= 0) document.getElementById(`swatch-${id}`).classList.add('active');
    updateModeButtons();
    renderBoard(); 
}

function renderBoard() {
    document.getElementById('rowInput').value = rows;
    document.getElementById('colInput').value = cols;

    const ch = document.getElementById('colHeader'); ch.innerHTML = '';
    for(let i=1; i<=cols; i++) {
        let d = document.createElement('div'); d.className = 'label col'; d.innerText = i; ch.appendChild(d);
    }
    const rh = document.getElementById('rowHeader'); rh.innerHTML = '';
    for(let i=1; i<=rows; i++) {
        let d = document.createElement('div'); d.className = 'label row'; d.innerText = i; rh.appendChild(d);
    }

    const container = document.getElementById('boardContainer');
    let table = document.createElement('table');
    for (let r = 0; r < rows; r++) {
        let tr = document.createElement('tr');
        for (let c = 0; c < cols; c++) {
            let td = document.createElement('td');
            let rid = regions[r][c];
            if (activeRegion >= 0 && rid === activeRegion) td.classList.add('active-brush-highlight');
            if (r === 0 || regions[r-1][c] !== rid) td.classList.add('b-t');
            if (r === rows - 1 || regions[r+1][c] !== rid) td.classList.add('b-b');
            if (c === 0 || regions[r][c-1] !== rid) td.classList.add('b-l');
            if (c === cols - 1 || regions[r][c+1] !== rid) td.classList.add('b-r');

            let badge = document.createElement('div');
            badge.className = 'rid-badge'; badge.innerText = rid;
            td.appendChild(badge);

            let input = document.createElement('input');
            input.className = 'cell-input';
            
            if (grid[r][c] === -2) {
                input.value = "X";
                input.classList.add('is-x');
            } else {
                input.value = grid[r][c] === -1 ? "" : grid[r][c];
                if (grid[r][c] !== -1) {
                    input.style.color = COLOR_MAP[grid[r][c]];
                    if([11,15,7].includes(grid[r][c])) input.style.textShadow = "0 0 2px rgba(0,0,0,0.5)";
                }
            }

            input.onmousedown = (e) => { 
                if(e.button === 0) { 
                    isMouseDown = true; 
                    if(activeRegion === -2) { grid[r][c] = (grid[r][c] === -2 ? -1 : -2); renderBoard(); }
                    else if(activeRegion >= 0) paint(r,c); 
                } 
                else if(e.button === 2) { selectBrush(regions[r][c]); }
            };
            input.onmouseenter = () => { if(isMouseDown && activeRegion >= 0) paint(r,c); };
            input.onkeydown = (e) => {
                if(e.key === "Backspace" || e.key === "Delete") { grid[r][c] = -1; renderBoard(); return; }
                if(e.key.toLowerCase() === 'x') { grid[r][c] = -2; renderBoard(); return; }
                if (e.key >= '0' && e.key <= '9') {
                    let val = parseInt((grid[r][c] >= 0 ? grid[r][c] : "") + e.key);
                    grid[r][c] = (val <= 15) ? val : parseInt(e.key);
                    renderBoard();
                }
            };
            td.appendChild(input); tr.appendChild(td);
        }
        table.appendChild(tr);
    }
    container.innerHTML = ""; container.appendChild(table);
}

function updateStats() {
    const counts = Array(16).fill(0);
    grid.forEach(row => row.forEach(val => { if(val >= 0) counts[val]++; }));
    const gridContainer = document.getElementById('statsGrid');
    gridContainer.innerHTML = '';
    let hasData = false;
    counts.forEach((count, i) => {
        if (count > 0) hasData = true;
        const item = document.createElement('div');
        item.className = 'stat-item';
        const textColor = [6, 7, 9, 10, 11, 12, 14, 15].includes(i) ? i===15?'#999':COLOR_MAP[i] : COLOR_MAP[i];
        item.innerHTML = `<div class="stat-num" style="color:${textColor}">${i}</div><div class="stat-count">${count}</div>`;
        gridContainer.appendChild(item);
    });
    document.getElementById('statsTableContainer').style.display = hasData ? 'block' : 'none';
}

function clearNumbers() { grid = grid.map(r => r.fill(-1)); renderBoard(); updateStats(); }
function clearRegions() { regions = regions.map(r => r.fill(0)); renderBoard(); }
function paint(r, c) { regions[r][c] = activeRegion; renderBoard(); }
window.onmouseup = () => isMouseDown = false;

function resize(dr, dc) {
    if (rows + dr < 2 || cols + dc < 2) return;
    const oldGrid = grid, oldRegs = regions;
    rows += dr; cols += dc;
    grid = Array(rows).fill().map((_, r) => Array(cols).fill().map((_, c) => (oldGrid[r] && oldGrid[r][c] !== undefined) ? oldGrid[r][c] : -1));
    regions = Array(rows).fill().map((_, r) => Array(cols).fill().map((_, c) => (oldRegs[r] && oldRegs[r][c] !== undefined) ? oldRegs[r][c] : 0));
    renderBoard();
}

function manualResize() { 
    let nr = parseInt(document.getElementById('rowInput').value);
    let nc = parseInt(document.getElementById('colInput').value);
    if(!isNaN(nr) && !isNaN(nc)) resize(nr-rows, nc-cols); 
}

// --- æ ¸å¿ƒæ±‚è§£é€»è¾‘ ---
function getConstraintGroups() {
    const groups = []; const v = Array(rows).fill().map(() => Array(cols).fill(false));
    for (let r = 0; r < rows; r++) for (let c = 0; c < cols; c++) if (!v[r][c]) {
        const id = regions[r][c], g = [], q = [[r, c]]; v[r][c] = true;
        while (q.length > 0) {
            const [cr, cc] = q.shift(); g.push([cr, cc]);
            [[cr-1, cc], [cr+1, cc], [cr, cc-1], [cr, cc+1]].forEach(([nr, nc]) => {
                if (nr >= 0 && nr < rows && nc >= 0 && nc < cols && !v[nr][nc] && regions[nr][nc] === id) { v[nr][nc] = true; q.push([nr, nc]); }
            });
        }
        groups.push(g);
    }
    return groups;
}

async function solveAsync(vals, g, groups) {
    if (stopFlag) return false;
    if (++iterations % 5000 === 0) { 
        document.getElementById('counter').innerText = `å·²å°è¯•ç»„åˆ: ${iterations.toLocaleString()}`; 
        await new Promise(r => setTimeout(r, 0)); 
    }
    let r = -1, c = -1, min = 100;
    for(let i=0; i<rows; i++) for(let j=0; j<cols; j++) {
        if(g[i][j] === -1) { // ä»…å¤„ç†ç©ºä½ï¼Œä¼šè‡ªåŠ¨è·³è¿‡ -2 (X)
            let cnt = vals.filter(v => isSafe(g, i, j, v, groups)).length;
            if(cnt < min) { min = cnt; r = i; c = j; }
        }
    }
    if (r === -1) return true;
    for (let v of vals) if (isSafe(g, r, c, v, groups)) {
        g[r][c] = v; if (await solveAsync(vals, g, groups)) return true; g[r][c] = -1;
    }
    return false;
}

function isSafe(g, r, c, v, groups) {
    for(let j=0; j<cols; j++) if(g[r][j] === v) return false;
    for(let i=0; i<rows; i++) if(g[i][c] === v) return false;
    const group = groups.find(gp => gp.some(co => co[0] === r && co[1] === c));
    for (let [gr, gc] of group) if (g[gr][gc] === v) return false;
    return true;
}

async function startSolving() {
    stopFlag = false; iterations = 0;
    const groups = getConstraintGroups();
    document.getElementById('solveBtn').style.display = 'none';
    document.getElementById('stopBtn').style.display = 'inline-block';
    document.getElementById('status').innerText = "æ±‚è§£ä¸­...";
    const workingGrid = JSON.parse(JSON.stringify(grid));
    const success = await solveAsync(Array.from({length:16}, (_,i)=>i), workingGrid, groups);
    if (success) { grid = workingGrid; renderBoard(); updateStats(); document.getElementById('status').innerText = "âœ… æ±‚è§£æˆåŠŸ"; }
    else { document.getElementById('status').innerText = stopFlag ? "â¹ å·²åœæ­¢" : "âŒ æ­¤é…ç½®æ— è§£"; }
    document.getElementById('solveBtn').style.display = 'inline-block'; document.getElementById('stopBtn').style.display = 'none';
}

function stopSolving() { stopFlag = true; }
initPalette(); renderBoard();
</script>
</body>
</html>